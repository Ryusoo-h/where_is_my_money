<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./style.css" />
    <title>WIMM</title>
</head>
<body>
    <header class="basic-layout">
        <div class="content">
            <h1 class="main-title">WIMM</h1>
            <p class="main-title-description">
                Where Is My Monny
            </p>
            <p class="sub-description">
               105 + ğŸ’¸ =
                <br/>50 + 25 + ğŸ’ª + 30 + ğŸ’— + ğŸ’°
            </p>
        </div>
        <div class="line">
            <div class="white"></div>
        </div>
    </header>
    <section id="list"></section>
    <script>
        const spreadsheetId = '1EdiKRryrgJpXInel87fNZQen0fATZy_3Z1Cw-R8M4T4';
        const sheetName = '2024-09';
        const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
        let spreadsheets;

        // ë¦¬ìŠ¤íŠ¸ë¥¼ ì¶œë ¥í•  DOM
        const listDOM = document.getElementById('list');

        fetch(url)
            .then(response => response.text())
            .then(data => {
                // 1. JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const jsonData = JSON.parse(data.substr(47).slice(0, -2));

                // 2. ì‚¬ìš©í•˜ê¸° í¸í•œ í˜•íƒœë¡œ ë³€í™˜
                // {
                //     'ë‚ ì§œ': {
                //         date: number;
                //         month: number;
                //         year: number;
                //     },
                //     'ë¶„ë¥˜': 'ê³ ì •ì§€ì¶œ' | 'ì €ì¶•' | 'ì‹ë¹„' | 'ê±´ê°•' | 'ì—¬ê°€' | 'í”Œë ‰ìŠ¤';
                //     'ìƒì„¸': string;
                //     'ê¸ˆì•¡': number;
                // }[]
                spreadsheets = jsonData.table.rows;
                spreadsheets = spreadsheets.map(v => {
                    const keys = ['ë‚ ì§œ', 'ë¶„ë¥˜', 'ìƒì„¸', 'ê¸ˆì•¡'];
                    const values = v.c;
                    let row = {};

                    for (let i = 0; i < keys.length; i++) {
                        if (i === 0) {
                            const [year, month, date] = values[i].v.slice(5, -1).split(',').map(v => Number(v));
                            row[keys[i]] = {year, month, date};
                        } else {
                            row[keys[i]] = values[i].v;
                        }
                    }
                    return row;
                })
                console.log(spreadsheets);

                // 3. DOMì— ë„£ê¸° ìœ„í•´ ê°€ê³µ

                // util function: categoryì— ë”°ë¼ ìƒ‰ìƒ í´ë˜ìŠ¤ ì´ë¦„ì„ return í•¨
                const getColorClassName = (category) => {
                    // less ì ì„ìˆ˜ë¡ ì¢‹ì€ ê²ƒ
                    // good ì›í•˜ëŠ”ë§Œí¼ í•  ê²ƒ
                    // fit ì ë‹¹íˆ í•  ê²ƒ
                    switch(category) {
                        case 'ê³ ì •ì§€ì¶œ':
                            return 'less1'
                        case 'ì €ì¶•':
                            return 'good1'
                        case 'ê±´ê°•':
                            return 'good2'
                        case 'ì‹ë¹„':
                            return 'fit1'
                        case 'ì—¬ê°€':
                            return 'fit2'
                        case 'í”Œë ‰ìŠ¤':
                            return 'less2'
                        default:
                            return 'basic'
                    }
                }

                // util function: priceì— ,ë¥¼ ì¶”ê°€í•´ì„œ return í•¨
                const formatForPrice = (price) => price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')


                // return: í†µê³„ ì»´í¬ë„ŒíŠ¸, í†µê³„ ë¹„ìœ¨
                const getStatus = () => {
                    let total = {
                        ['ê³ ì •ì§€ì¶œ'] : 0,
                        ['ì €ì¶•'] : 0,
                        ['ê±´ê°•'] : 0,
                        ['ì‹ë¹„'] : 0,
                        ['ì—¬ê°€'] : 0,
                        ['í”Œë ‰ìŠ¤'] : 0,
                    }

                    spreadsheets.forEach(v => {
                        switch(v['ë¶„ë¥˜']) {
                            case 'ê³ ì •ì§€ì¶œ':
                                total['ê³ ì •ì§€ì¶œ'] += v['ê¸ˆì•¡'];
                                break;
                            case 'ì €ì¶•':
                                total['ì €ì¶•'] += v['ê¸ˆì•¡'];
                                break;
                            case 'ê±´ê°•':
                                total['ê±´ê°•'] += v['ê¸ˆì•¡'];
                                break;
                            case 'ì‹ë¹„':
                                total['ì‹ë¹„'] += v['ê¸ˆì•¡'];
                                break;
                            case 'ì—¬ê°€':
                                total['ì—¬ê°€'] += v['ê¸ˆì•¡'];
                                break;
                            case 'í”Œë ‰ìŠ¤':
                                total['í”Œë ‰ìŠ¤'] += v['ê¸ˆì•¡'];
                                break;
                            default:
                                console.debug('ë¶„ë¥˜ê°€ ì§€ì •ë˜ì§€ ì•Šì€ ì†Œë¹„ê°€ ìˆìŠµë‹ˆë‹¤')
                        }
                    })

                    // content ì˜ì—­ ì»´í¬ë„ŒíŠ¸
                    const ê³ ì •ì§€ì¶œ = `<div class='${getColorClassName('ê³ ì •ì§€ì¶œ')} each total'><h3>ê³ ì •ì§€ì¶œ</h3><span>${formatForPrice(total['ê³ ì •ì§€ì¶œ'])}ì›</span></div>`
                    const ì €ì¶• = `<div class='${getColorClassName('ì €ì¶•')} each total'><h3>ì €ì¶•</h3><span>${formatForPrice(total['ì €ì¶•'])}ì›</span></div>`
                    const ê±´ê°• = `<div class='${getColorClassName('ê±´ê°•')} each total'><h3>ê±´ê°•</h3><span>${formatForPrice(total['ê±´ê°•'])}ì›</span></div>`
                    const ì‹ë¹„ = `<div class='${getColorClassName('ì‹ë¹„')} each total'><h3>ì‹ë¹„</h3><span>${formatForPrice(total['ì‹ë¹„'])}ì›</span></div>`
                    const ì—¬ê°€ = `<div class='${getColorClassName('ì—¬ê°€')} each total'><h3>ì—¬ê°€</h3><span>${formatForPrice(total['ì—¬ê°€'])}ì›</span></div>`
                    const í”Œë ‰ìŠ¤ = `<div class='${getColorClassName('í”Œë ‰ìŠ¤')} each total'><h3>í”Œë ‰ìŠ¤</h3><span>${formatForPrice(total['í”Œë ‰ìŠ¤'])}ì›</span></div>`

                    const ì§€ì¶œí†µê³„ = ê³ ì •ì§€ì¶œ + ì €ì¶• + ê±´ê°• + ì‹ë¹„ + ì—¬ê°€ + í”Œë ‰ìŠ¤;
                    const ì´ê¸ˆì•¡ = Object.values(total).reduce((addedTotal, value) => addedTotal + value, 0)

                    const monthTitle = `<div class="title-wrapper total"><h2>${spreadsheets[0]['ë‚ ì§œ'].month + 1}</h2><span>${formatForPrice(ì´ê¸ˆì•¡)}ì›</span></div>`

                    // line ì˜ì—­ ì»´í¬ë„ŒíŠ¸
                    const ê³ ì •ì§€ì¶œGraph = `<div class='${getColorClassName('ê³ ì •ì§€ì¶œ')} graph'></div>`
                    const ì €ì¶•Graph = `<div class='${getColorClassName('ì €ì¶•')} graph'></div>`
                    const ê±´ê°•Graph = `<div class='${getColorClassName('ê±´ê°•')} graph'></div>`
                    const ì‹ë¹„Graph = `<div class='${getColorClassName('ì‹ë¹„')} graph'></div>`
                    const ì—¬ê°€Graph = `<div class='${getColorClassName('ì—¬ê°€')} graph'></div>`
                    const í”Œë ‰ìŠ¤Graph = `<div class='${getColorClassName('í”Œë ‰ìŠ¤')} graph'></div>`

                    const ê·¸ë˜í”„ = ê³ ì •ì§€ì¶œGraph + ì €ì¶•Graph + ê±´ê°•Graph + ì‹ë¹„Graph + ì—¬ê°€Graph + í”Œë ‰ìŠ¤Graph

                    const totalRatio = Object.values(total).map(v => Math.round((v/ì´ê¸ˆì•¡) * 100))

                    return [`<div class="total-wrapper content">${monthTitle}${ì§€ì¶œí†µê³„}</div><div class="line">${ê·¸ë˜í”„}</div>`, totalRatio]
                }

                // return: ë¦¬ìŠ¤íŠ¸ ì»´í¬ë„ŒíŠ¸
                const getList = () => {
                    let prevDate = 0 // ì´ì „ ë‚ ì§œì™€ ë‹¤ë¥´ë©´ ë‚ ì§œë¥¼ ìˆ¨ê¸°ì§€ ì•Šë„ë¡ í•˜ê¸°ìœ„í•´ ë³€ìˆ˜ í•„ìš”.
                    const getListLI = (date, category, detail, price) => {
                        const day = new Date(spreadsheets[0]['ë‚ ì§œ'].year, spreadsheets[0]['ë‚ ì§œ'].month, date).getDay()
                        const dateSpan = `<span class="date ${day === 0 ? 'sun' : ''} ${day === 6 ? 'set' : ''}">${date}</span>`;
                        const detailSpan = `<span class="detail">${detail}</span>`;
                        const priceSpan = `<span class="price">${formatForPrice(price)}</span>`;
                        let listClassName = '';

                        const isSameDate = prevDate == date;
                        if (!isSameDate) {
                            prevDate = date;
                        }
                        return `<li class='${getColorClassName(category)} ${isSameDate ? 'hidden-date' : ''}'>${dateSpan}${detailSpan}${priceSpan}</li>`
                    };
                    return spreadsheets.reverse().map(v => getListLI(v['ë‚ ì§œ'].date, v['ë¶„ë¥˜'], v['ìƒì„¸'], v['ê¸ˆì•¡'] )).join('')
                }

                // 4. DOMì— ì¶”ê°€
                const [listStatus, totalRatio] = getStatus();

                listDOM.innerHTML = `<section class="consumption-statistics basic-layout">${listStatus}</section>`
                    + `<section class="consumption-list basic-layout"><ul class="content monthly-list">${getList()}</ul><div class="line"></div></section>`


                // 5. ê·¸ë˜í”„ ë¹„ìœ¨ ì ìš©
                const graphLine = document.querySelectorAll('.consumption-statistics .line > div');
                graphLine.forEach((v, i) => {
                    v.style.height = `${(250/100) * totalRatio[i]}px`
                })
            })
            .catch(error => console.error('Error fetching data:', error));
    </script>
</body>
</html>